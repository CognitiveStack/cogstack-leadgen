# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
# Install dependencies
uv sync

# Run main entry point
uv run python main.py

# One-time: create Notion databases (requires NOTION_API_KEY and NOTION_PAGE_ID in .env)
uv run create_notion_databases.py

# Test the n8n webhook with 3 sample leads
export WEBHOOK_URL="https://n8n.bigtorig.com/webhook/lead-ingestion-v2"
export WEBHOOK_TOKEN="<token from .env>"
uv run test_webhook.py
```

There is no test suite yet. Syntax-check Python files with:
```bash
python3 -m py_compile main.py create_notion_databases.py test_webhook.py
```

## Architecture

This is an AI-powered B2B lead generation pipeline for a South African vehicle tracking company. The goal is 10 qualified leads/month delivered to a human QA reviewer via Notion.

**Data flow:**
```
OpenClaw (Raspberry Pi 4, Tailscale VPN)
    │  POST JSON: { batch_id, leads[] }
    ▼
n8n Webhook (https://n8n.bigtorig.com/webhook/lead-ingestion-v2)
    │  Code node: validate → dedup by company name → create Notion records
    ▼
Notion Workspace: 3 linked databases
    ├── Leads DB      — 28-field schema; new leads arrive as "Pending QA"
    ├── Batches DB    — one record per ingestion run (status, counts, errors)
    └── Sources DB    — reference data (CIPC, eTenders, Yellow Pages, etc.)
    ▼
Claire/Paul manually review leads in Notion UI
    ├── QA Approved → Sent to Paul's call centre
    └── QA Rejected → Feeds back into AI tuning
```

**n8n integration — two workflow versions:**
- `n8n_lead_ingestion_workflow.json` — v1 (8 Notion nodes). Had property-mapping issues. Keep for reference but do not use.
- `n8n_code_node.js` — v2 replacement. Single Code node using direct Notion REST API calls via `$http.request()` (n8n-native). This is the active implementation.

The Code node hardcodes `NOTION_API_KEY` and the three database IDs. When modifying it, update those constants from `notion_config.json` or `.env`.

**Scoring model (Composite Score):**
```
(Fleet Likelihood × 0.4) + (Tracking Need Score × 0.4) + (Fleet Size Bonus × 0.2)
```
- Fleet Likelihood / Tracking Need: 0–10 scale
- Fleet Size Bonus: 0 (small), 1 (medium), 2 (large)
- Phase B (future): auto-approve ≥ 7, auto-reject < 4

**QA status states:**
`Pending QA → QA Approved → Sent to Call Centre → Contacted → Converted / Not Interested`
`Pending QA → QA Rejected`
`Pending QA → Duplicate`

## Environment

Copy `.env` variables for local scripts. Required variables:
- `NOTION_API_KEY` — Notion integration token (`ntn_...`)
- `NOTION_PAGE_ID` — Parent page ID where databases live
- `LEADS_DB_ID`, `SOURCES_DB_ID`, `BATCHES_DB_ID` — generated by `create_notion_databases.py`, also in `notion_config.json`

Notion API version in use: `2022-06-28` (stable). Formula and Rollup properties cannot be created via API — they must be added manually in the Notion UI after running the setup script (see `.claude/docs/SETUP_GUIDE.md`).

## Key files

| File | Purpose |
|------|---------|
| `create_notion_databases.py` | One-time schema setup; seeds Sources with 6 SA data sources |
| `test_webhook.py` | Sends 3 realistic sample leads; validates end-to-end pipeline |
| `n8n_code_node.js` | Active n8n Code node — paste into v2 workflow |
| `notion_config.json` | Generated DB IDs (committed for reference) |
| `.claude/docs/` | Session notes, setup guide, workflow docs |
